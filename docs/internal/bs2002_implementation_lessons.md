# BS2002実装の失敗から学んだ教訓

## 失敗の概要
- 実装日: 2025-01-26
- 削除日: 2025-01-26
- 問題: 217%の誤差（期待値6.248に対し19.831）

## 技術的問題点

### 1. Trigger Price計算の誤り
- **期待値**: ~100-120（ATMオプションの合理的範囲）
- **実際の値**: ~200（異常に高い）
- **問題のコード**:
  ```rust
  let h_t = -(b * t + 2.0 * sigma * t.sqrt());
  let i = b0 + (b_inf - b0) * (1.0 - h_t.exp());
  ```
- **原因**: h(t)関数の計算式が原論文と異なる可能性

### 2. Put-Call Transformation失敗
- **使用式**: `P(S,K,r,q) = C(K,S,q,r)`
- **結果**: 変換後も217%誤差が残存
- **推測原因**: 
  - psi関数の符号処理エラー
  - パラメータ変換時の境界条件の誤り
  - alpha係数が異常に小さくなる（ほぼゼロ）

### 3. 数値不安定性
- 中間計算で極端な値が発生
- オーバーフロー/アンダーフロー保護が不十分
- 特にディープOTM/ITMで顕著

## 教訓

### 1. 複雑な金融モデルの実装原則
- **段階的検証の必要性**: 各中間計算値を個別に検証
- **参照実装との比較**: QuantLib等の信頼できる実装と比較
- **境界値テスト**: 極端なパラメータでの動作確認

### 2. デバッグ戦略
- 中間値の可視化とロギング
- 各関数の単体テスト作成
- 既知の正解値との継続的比較

### 3. 技術的負債の管理
- **Critical Rule C013適用**: 修正不能なコードは即削除
- コメントアウトによる残存は混乱の元
- Git履歴で十分（復元可能）

## 代替手法の成功

### BAW (Barone-Adesi-Whaley) 1987
- **精度**: 0.98%誤差（BENCHOP基準）
- **性能**: 0.27μs/計算
- **安定性**: 全パラメータ領域で安定
- **改善**: 経験的dampening factor (0.695)で精度向上

### Adaptive Dampening（実装済み）
- モネーネスに応じた動的調整
- 満期までの時間による調整
- ボラティリティレベルによる調整
- 0.60-0.80の範囲で自動調整

## BS2002の将来的な再実装への指針

もし将来BS2002を再実装する場合：

1. **クリーンルーム実装**
   - 原論文から直接実装
   - 既存コードを参照しない
   
2. **段階的実装とテスト**
   - まずヨーロピアンオプションで検証
   - 各係数（alpha, beta）の単体テスト
   - trigger priceの独立検証
   
3. **Put直接実装**
   - Put-Call変換を避ける
   - Putオプション用の式を直接実装

## 削除の正当性

### Critical Rules準拠
- **C002**: エラー迂回禁止 → 問題のあるコードを削除
- **C013**: 破壊的リファクタリング推奨 → 技術的負債を解消

### ビジネス価値
- BAWで十分な精度を達成（<1%誤差）
- BS2002の追加価値が不明確
- 保守コストとリスクの削減

## 参考資料

### 原論文
- Bjerksund, P., & Stensland, G. (2002). "Closed form valuation of American options"

### 削除時の状態
- 削除コミット: [このドキュメント作成時点でのコミット]
- ファイルサイズ: 5,505バイト
- 関数数: 10関数（すべて未使用）
- テスト: 2テスト（両方とも#[ignore]）

### 関連ドキュメント
- `docs/internal/american_option_implementation_notes.md`: 全体的な実装方針
- `core/src/constants.rs`: BAW dampening factorの定義

## 結論

BS2002実装は理論的には優れているが、実装の複雑さと検証の困難さから、現時点では削除が最良の選択。BAW with dampening（0.98%誤差）が実用上十分な精度を提供しており、追加の複雑性を正当化する利益が見込めない。

将来的に必要になった場合は、このドキュメントの教訓を活かし、より慎重な実装アプローチを取ること。