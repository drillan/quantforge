# 並列化閾値最適化レポート

## エグゼクティブサマリー

2025年8月31日、QuantForgeの並列化閾値を最適化し、10,000要素バッチで**2.07倍**の性能向上を達成しました。
新しい閾値設定により、8,000要素以上でNumPyを上回る性能を実現しています。

## 問題の発見

### 初期状態
- `PARALLEL_THRESHOLD_SMALL = 50,000`
- 10,000要素: NumPyの0.74倍（遅い）
- 並列化オーバーヘッドがメリットを上回る

### 根本原因
- 並列化閾値が高すぎて、中規模バッチ（8,000〜50,000要素）がシーケンシャル処理
- Rayonのワークスティーリングオーバーヘッドが小規模データで顕著

## 実施した最適化

### 実測に基づく閾値調整

```rust
// 変更前
pub const PARALLEL_THRESHOLD_SMALL: usize = 50_000;

// 変更後
pub const PARALLEL_THRESHOLD_SMALL: usize = 8_000;
```

### 判断根拠
- 1,000要素: クロスオーバーポイント（QF = NumPy）
- 8,000要素: 安全マージンを含む実用的な閾値
- 10,000要素以上: 明確な性能優位性

## パフォーマンス改善結果

### 主要サイズでの改善

| バッチサイズ | 改善前 | 改善後 | 改善率 | NumPy比 |
|------------|--------|--------|--------|---------|
| 100要素 | 9.31x | 9.31x | - | 高速維持 |
| 1,000要素 | 1.65x | 1.65x | - | 高速維持 |
| **10,000要素** | **0.74x** | **2.07x** | **+180%** | **高速化達成** |
| 20,000要素 | 0.74x | 2.18x | +195% | 高速化達成 |
| 50,000要素 | 2.95x | 3.10x | +5% | さらに高速 |
| 100,000要素 | 3.14x | 3.24x | +3% | さらに高速 |

### スループット向上

10,000要素バッチ:
- 改善前: 13.3M ops/s
- 改善後: 36.6M ops/s
- **向上率: +175%**

## 技術的詳細

### 並列化戦略の階層

```
要素数 ≤ 200: マイクロバッチ最適化（ループアンローリング）
要素数 ≤ 8,000: 高速シーケンシャル処理
要素数 > 8,000: Rayon並列処理
```

### キャッシュ効率の改善
- L1キャッシュ: 小規模データで高ヒット率維持
- L2/L3キャッシュ: 中規模データで効率的利用
- メモリ帯域: 2.28 GB/s（100万要素）

## スケーリング特性

```
Size      QF Performance    vs NumPy
100       10.58 M ops/s     9.31x
1,000     13.08 M ops/s     1.65x
10,000    36.63 M ops/s     2.07x  ← 最適化効果
100,000   50.63 M ops/s     3.24x
1,000,000 50.98 M ops/s     2.91x
```

## ベストプラクティス

### 推奨使用パターン

1. **小規模バッチ（< 1,000）**
   - 最高の相対性能（NumPyの8-9倍）
   - リアルタイムトレーディングに最適

2. **中規模バッチ（1,000-50,000）**
   - 安定した高性能（NumPyの1.5-3倍）
   - バックテスト・シミュレーションに最適

3. **大規模バッチ（> 50,000）**
   - 優れたスループット（50M+ ops/s）
   - 大規模分析・リスク計算に最適

## 今後の最適化機会

### 短期（実装済み）
- ✅ 並列化閾値の最適化
- ✅ マイクロバッチ最適化
- ✅ Black76/Mertonバインディング修正

### 中期
- [ ] 動的閾値調整（CPUコア数に基づく）
- [ ] NUMA対応メモリアロケーション
- [ ] プリフェッチヒントの追加

### 長期
- [ ] GPUアクセラレーション（100万要素以上）
- [ ] AVX-512活用（コンパイラ最適化）
- [ ] カスタムメモリアロケーター

## 結論

並列化閾値を50,000から8,000に調整することで、中規模バッチ（8,000〜50,000要素）の性能を大幅に改善しました。特に10,000要素での**180%の性能向上**は、実用的なユースケースで大きな価値を提供します。

この最適化により、QuantForgeはあらゆるバッチサイズでNumPyを上回る性能を実現し、高頻度取引からリスク分析まで幅広い用途に対応できます。

## 測定環境

- CPU: 6コア / 12スレッド
- メモリ: 29.3GB
- OS: Linux 6.12.10
- Rust: stable
- Python: 3.12.5

## 参考資料

- [Small Batch Optimization Report](./small-batch-optimization-report.md)
- [Core + Bindings Architecture](../plans/2025-08-30-core-bindings-restructure/README.md)
- ベンチマークコード: `benchmarks/test_threshold_impact.py`