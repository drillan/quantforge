# プロジェクトコンテキスト

## プロジェクト概要
QuantForgeは高性能オプション価格計算ライブラリで、Rust + PyO3による実装により、Pythonから高速な金融計算を実行できます。

## 技術的制約

### パフォーマンス要件
- **単一計算**: < 10ns
- **バッチ処理**: NumPyと同等以上
- **メモリ効率**: 入力データの2倍以内
- **並列化効率**: GILリリース率 > 95%

### 精度要件
- **相対誤差**: < 1e-3（実用精度）
- **テスト精度**: < 1e-10（SciPy比較）
- **数値安定性**: Deep OTM/ITMでも安定

## 技術選定理由

### Rust + PyO3
- **選定理由**: 
  - ゼロコストアブストラクション
  - メモリ安全性保証
  - NumPy配列の直接操作
  - GIL解放による真の並列処理

### libm（数学関数）
- **選定理由**:
  - 高精度erf実装（機械精度レベル）
  - クロスプラットフォーム対応
  - 標準準拠の数学関数

### Rayon（並列処理）
- **選定理由**:
  - ワークスティーリングによる効率的な負荷分散
  - 安全な並列処理の保証
  - 動的なスレッド数調整

## アーキテクチャ制約

### Core+Bindings分離アーキテクチャ（2025-09-01確認）
- **Core層**: 純粋Rust実装、PyO3非依存
- **Bindings層**: PyO3ラッパー、FFI最適化
- **利点**: 
  - 他言語バインディングの追加が容易
  - Core層の単体テストがPython不要
  - 責任分離の明確化

### 並列化閾値（2025-09-01検証）
```rust
pub const PARALLEL_THRESHOLD_SMALL: usize = 8_000;
pub const PARALLEL_THRESHOLD_MEDIUM: usize = 200_000;
pub const PARALLEL_THRESHOLD_LARGE: usize = 1_000_000;
```
- **根拠**: 実測によるFFIオーバーヘッドと並列化コストのバランス
- **重要**: 8,000要素未満では逐次処理が高速（commit 7dbf51e）
- **検証済み**: BroadcastIteratorOptimizedで750%改善を確認

### キャッシュ最適化
```rust
pub const OPTIMAL_CHUNK_SIZE: usize = 1_024;
```
- **根拠**: L1キャッシュライン（64KB）の効率的利用

## 開発原則

### 技術的負債ゼロ
- 段階的実装禁止
- 妥協実装禁止
- 理想実装ファースト

### コード品質基準
- 重複率: < 5%（similarity-rs測定）
- テストカバレッジ: > 90%
- unsafe使用: 4箇所以下
- unwrap使用: 本番コード0

## 制約事項

### SIMD最適化
- **現状**: 使用しない
- **理由**: 
  - マルチプラットフォーム対応の複雑性
  - Rustエコシステムの未成熟（std::simd still nightly）
  - 保守コスト > パフォーマンス向上

### Python互換性
- **対象**: Python 3.12+ (abi3-py312)
- **制約**: NumPy配列との相互運用必須

## パフォーマンス目標と現状（2025-08-30）

| データサイズ | 目標 | 現状 | NumPy比 |
|------------|------|------|---------|
| 100 | 10μs以下 | 7.4μs ✅ | 9.77x |
| 1,000 | 100μs以下 | 61.5μs ✅ | 1.85x |
| 10,000 | 1ms以下 | 207.8μs ✅ | 2.79x |
| 100,000 | 10ms以下 | 1.03ms ✅ | 7.03x |
| 1,000,000 | 100ms以下 | 9.71ms ✅ | 6.89x |