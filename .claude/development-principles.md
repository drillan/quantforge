# Development Principles

QuantForgeプロジェクトの核心的な開発原則。過去の経験から得た技術的負債ゼロの実装方針。

## 🚫 技術的負債ゼロの原則 [C004, C014適用]

### 基本方針
技術的負債を一切作らない。段階的実装や一時的な実装は行わず、最初から理想形を実装。

### 禁止パターン（アンチパターン）

#### ❌ 段階的移行
- Python実装を作ってからRustに移植
- 「とりあえず動くもの」を作って後で改善
- プロトタイプを本番コードに含める

#### ❌ 重複実装
- 同じ機能の複数バージョンを共存させる
- 互換性レイヤーやアダプターの追加
- レガシーコードを残したまま新実装を追加

#### ❌ 中途半端な最適化
- 「後で最適化する」前提の実装
- 「将来的に並列化する」前提の設計
- パフォーマンスを後回しにした実装

### 推奨パターン

#### ✅ 最初から理想形
- Rust + PyO3で直接実装
- 並列化を最初から組み込む
- 高精度数学関数を最初から実装

#### ✅ 機能の垂直統合
- 1つの機能を完全に実装してから次へ
- テスト・ドキュメント・最適化を含めて完成させる
- 部分的な機能の放置を避ける

#### ✅ 明確な境界
- 実装する/しないを明確に分ける
- スコープクリープを防ぐ
- 将来の拡張点を明確に定義

### 例外条件
技術的検証が必要な未知の領域のみ、draft/に隔離して実験可能。

## 🔒 ハードコード禁止ポリシー [C011-3適用]

### 基本原則
**すべての設定値は必ず定義済みの場所から参照する。ハードコードは技術的負債。**

### 許可される直接記述
- 0, 1, 2, -1, 0.5（1/2）のみ
- それ以外は全て名前付き定数として定義

### 定数配置ルール

| 種類 | 配置場所 | 例 |
|------|----------|-----|
| 精度・許容誤差 | src/constants.rs + tests/conftest.py | PRACTICAL_TOLERANCE |
| 数学定数・係数 | 使用箇所の近くで const 定義 | Abramowitz係数 |
| 入力検証制限 | src/validation.rs の InputLimits | 価格・時間の範囲 |
| テスト用値 | tests/conftest.py または各テストファイル | 標準テストケース |

### 実装前の必須チェック

```bash
# 既存定数の確認
grep -r "const.*=" src/constants.rs src/config/
grep -r "TOLERANCE\|EPSILON" tests/conftest.py

# 類似値の検索（例：1e-3を探す場合）
rg "1e-3\|0\.001" --type rust --type python

# ハードコード検出
./scripts/detect_hardcode.sh
```

### 違反例と改善例

```rust
// ❌ 違反：マジックナンバー
if x > 8.0 { return 1.0; }

// ✅ 改善：名前付き定数
const NORM_CDF_UPPER_BOUND: f64 = 8.0;  // 正規分布の実質的な上限（Φ(8) ≈ 1.0）
if x > NORM_CDF_UPPER_BOUND { return 1.0; }
```

## 🔄 破壊的リファクタリング推奨 [C013適用]

### 基本原則
**過去の実装は全て置換対象。今作るものが唯一の正解。**

### No Archive Policy

#### ファイル命名で禁止
- `file.old`
- `file.backup`
- `file_v1.py`
- `file_legacy.py`
- `file_deprecated.py`

#### コード内で禁止
```python
# ❌ 禁止：レガシー保持
class BlackScholes:     # 現行
class BlackScholesOld:  # 旧実装を残す → 禁止！

# ✅ 必須：レガシー完全削除
class BlackScholes:  # 唯一の実装のみ
```

### レガシーコード即座削除リスト
- 古い命名規則（例: calculate_*）
- V2、V3などバージョン付きクラス/関数
- `_old`、`_legacy`、`_deprecated` サフィックス
- コメントアウトされた旧実装
- TODO/FIXMEコメント（即座に解決または削除）

### 実装判断フロー
```
if ドキュメントと実装が不一致:
    # 議論不要、より良い方を採用
    better = select_better(doc, impl)
    implement(better)
    # 悪い方は跡形もなく削除（記録も残さない）
```

## 📚 ドキュメント駆動開発 [C008適用]

### 根本原則
**ドキュメントは唯一の真実。実装はその具現化。計画は一時的な設計メモ。**

### 情報源の優先順位

1. **docs/api/** - 唯一の真実（最優先）
   - 現在有効な仕様のみ
   - ユーザーとの契約

2. **実装コード** - ドキュメントの具現化
   - ドキュメントに完全準拠
   - ドキュメントにない機能は存在禁止

3. **plans/archive/** - 設計メモ（参照禁止）
   - 過去の記録（誤りを含む）
   - 参照による誤謬リスク

### 正しい実装フロー

#### 新機能開発
1. 計画作成（plans/） → 設計検討のみ
2. ドキュメント作成（docs/api/） → ここで仕様確定
3. ドキュメントから実装へコピペ → 手打ち禁止
4. 検証（ドキュメントと実装の一致）
5. 計画をarchive/へ → 以降参照禁止

#### 既存機能修正
1. docs/api/ で現在の仕様確認 ← 必須
2. 計画文書は一切参照しない ← 絶対
3. ドキュメント通りに実装

## 🎯 Break Everything Better (BEB) 原則

### 破壊的変更の積極推奨

#### 変更時のルール
1. **即座置換**: 過去との共存期間なし
2. **記録最小化**: 変更履歴を詳細に残さない
3. **完全削除**: 古い実装の痕跡を残さない

### 実装例
```python
# 月曜日の実装
def calculate_call_price(spot, strike, time, rate, vol):
    pass

# 火曜日：より良い名前を発見
# → calculate_call_priceは削除（コメントも残さない）
def black_scholes_call(s, k, t, r, sigma):
    pass

# 水曜日：さらに良い設計
# → 前日の実装も削除（履歴はgitのみ）
class BlackScholes:
    def call_price(self, s, k, t, r, sigma):
        pass
```

## 🚫 No Noise Policy (NNP)

### コード内で禁止するノイズ
- 「以前は〜だった」というコメント
- 「旧API」「レガシーサポート」等の記述
- deprecation warning
- 移行ガイド、マイグレーション文書
- 過去バージョンとの比較表

### 許可される記録
- `plans/archive/` - 歴史的記録（参照は禁止）
- gitコミット履歴 - 最小限の変更記録
- 現在の仕様のみを記載したドキュメント

## 💎 Clean Slate Implementation

### コミットメッセージ規則
```bash
# ❌ 避けるべき：過去への言及
"Refactor calculate_call_price to black_scholes_call"
"Deprecate old API"
"Add backward compatibility"

# ✅ 推奨：現在形・未来志向
"Implement black_scholes module"
"Add optimal pricing algorithm"
"Improve API design"
```

### 実装判断フローチャート

1. **理想形が明確か？**
   - Yes → 2へ
   - No → 設計を完成させてから実装

2. **必要な技術がすべて利用可能か？**
   - Yes → 3へ
   - No → 技術調査を別途実施（draft/に記録）

3. **一度の実装で完成できるか？**
   - Yes → 実装開始
   - No → スコープを縮小して完成可能な単位に

4. **既存コードとの重複はないか？**
   - No → 実装継続
   - Yes → 既存コードを削除してから新実装

## 🏁 開発チェックリスト

実装時の必須確認事項：

- [ ] レガシーコードを見つけたら即削除
- [ ] 後方互換性を一切考慮しない
- [ ] V2クラスやold_*関数を作らない
- [ ] コメントに旧実装を残さない
- [ ] plans/archive以外にアーカイブを作らない
- [ ] 破壊的変更を恐れず実施
- [ ] 理想実装のみを追求
- [ ] ハードコードを一切含まない
- [ ] ドキュメントと実装が完全一致
- [ ] テストを先に書いた（TDD）