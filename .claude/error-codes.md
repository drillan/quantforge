# Critical Rules エラーコード体系

このファイルは .claude/critical-rules.xml のエラーコードをQuantForgeプロジェクト向けに解説します。

## C001: ルール歪曲禁止・最上位命令遵守
- **検出時**: AIアシスタントのみ適用
- **アクション**: ルールの厳密な解釈と適用

## C002: エラー迂回絶対禁止・主観判断排除
- **検出時**: エラー発生時
- **アクション**: 即座に修正 or 作業停止
- **QuantForge固有**: 
  - Rust/Pythonの両方でエラーチェック必須
  - `cargo test` と `pytest` の両方でエラーゼロ必須

## C003: 冒頭表示必須
- **検出時**: 作業開始時
- **アクション**: Critical Rules確認
- **QuantForge固有**: CLAUDE.md の冒頭で参照

## C004: 理想実装ファースト原則
- **検出時**: 新規実装時
- **アクション**: 設計見直し
- **QuantForge固有**: 
  - Rust + PyO3での直接実装
  - 段階的Python実装の禁止

## C005: 記録管理徹底
- **検出時**: 設計決定・問題発生時
- **アクション**: plans/ディレクトリに記録
- **QuantForge固有**: 
  - plans/YYYY-MM-DD-*.md 形式で記録

## C006: 堅牢コード品質
- **検出時**: コード作成時
- **アクション**: 品質チェック実行
- **QuantForge固有**: 
  - `ruff`, `mypy`, `cargo clippy` 必須

## C007: 品質例外化禁止
- **検出時**: 時間制約・緊急時
- **アクション**: 品質基準の厳守
- **QuantForge固有**: 
  - デッドラインを理由にした妥協禁止

## C008: ドキュメント整合性絶対遵守
- **検出時**: 実装前
- **アクション**: 仕様確認→実装
- **QuantForge固有**: 
  - docs/ディレクトリと実装の同期

## C009: 実装計画ブランチ作成必須
- **検出時**: 新機能開発時
- **アクション**: ブランチ作成
- **QuantForge固有**: 
  - 現在は個人開発のためmain直接も可

## C010: テスト駆動開発必須
- **検出時**: 新機能実装時
- **アクション**: テスト作成→実装
- **QuantForge固有**: 
  - pytest + cargo test の両方で検証
  - ゴールデンマスターテストも活用

## C011: データ正確性絶対遵守
### C011-1: 一次データ推測禁止
- **検出時**: データ取得時
- **アクション**: 確実なソースから取得

### C011-2: フォールバック禁止
- **検出時**: エラー処理時
- **アクション**: エラーを明示的に伝播

### C011-3: 設定値ハードコード禁止
- **検出時**: 定数使用時
- **アクション**: constants.rs/conftest.py参照
- **検証**: `./scripts/detect_hardcode.sh`

## C012: DRY原則絶対遵守
- **検出時**: コード作成時
- **アクション**: 共通化リファクタリング
- **QuantForge固有**: 
  - Rust/Python間の重複も禁止
  - 共通ロジックはRustに集約

## C013: 破壊的リファクタリング推奨
- **検出時**: 機能改善時
- **アクション**: V2クラス削除→既存修正
- **QuantForge固有**: 
  - `_v2.py`, `ModuleV2.rs` などの命名禁止
  - 既存の `BlackScholes` クラスを直接改善

## C014: 妥協実装絶対禁止原則
- **検出時**: 実装開始時
- **アクション**: 理想設計の確立
- **QuantForge固有**: 
  - 「とりあえず動く」Python版の禁止
  - 最初からRust実装

## 検証コマンド

```bash
# 全ルールの一括検証
./scripts/check_critical_rules.sh

# 個別ルール検証
./scripts/detect_hardcode.sh    # C011-3
cargo test --release            # C010
uv run pytest                   # C010
uv run ruff check .            # C006
uv run mypy .                  # C006
```

## 違反時の対応フロー

1. **検出**: check_critical_rules.sh で違反検出
2. **分析**: エラーコードから原因特定
3. **修正**: 即座に修正（C002）
4. **検証**: 再度スクリプト実行
5. **記録**: plans/に対応記録（C005）