# [Rust] [タイトル] 実装計画

## メタデータ
- **作成日**: YYYY-MM-DD
- **言語**: Rust
- **ステータス**: DRAFT
- **推定規模**: [小/中/大]
- **推定コード行数**: [数値]
- **対象モジュール**: [src/models, src/math, src/lib.rs など]

## タスク規模判定

### 判定基準
- [ ] 推定コード行数: _____ 行
- [ ] 新規ファイル数: _____ 個
- [ ] 影響範囲: [単一モジュール/複数モジュール/全体]
- [ ] PyO3バインディング: [必要/不要]
- [ ] SIMD最適化: [必要/不要/将来対応]
- [ ] 並列化: [必要/不要/将来対応]

### 規模判定結果
**[小規模/中規模/大規模]タスク**

## 品質管理ツール（Rust）

### 適用ツール（規模に応じて自動選択）
| ツール | 小規模 | 中規模 | 大規模 | 実行コマンド |
|--------|--------|--------|--------|-------------|
| cargo test | ✅ | ✅ | ✅ | `cargo test --all` |
| cargo clippy | ✅ | ✅ | ✅ | `cargo clippy -- -D warnings` |
| cargo fmt | ✅ | ✅ | ✅ | `cargo fmt --check` |
| similarity-rs | - | 条件付き | ✅ | `similarity-rs --threshold 0.80 src/` |
| rust-refactor.md | - | 条件付き | ✅ | `.claude/commands/rust-refactor.md` 適用 |
| cargo bench | - | 推奨 | ✅ | `cargo bench` |
| miri（安全性） | - | - | 推奨 | `cargo +nightly miri test` |

## フェーズ構成（規模に応じて選択）

<!-- ============ 小規模タスク（< 100行）============ -->
<details>
<summary>小規模実装フェーズ</summary>

### Phase 1: 実装（1-2時間）
- [ ] 単一機能の実装
- [ ] ユニットテスト作成
- [ ] docstring/コメント追加

### Phase 2: 品質チェック（30分）
```bash
cargo test
cargo clippy -- -D warnings
cargo fmt --check
```

### Phase 3: 完了確認
- [ ] 機能動作確認
- [ ] PyO3バインディング確認（必要な場合）
- [ ] ドキュメント更新

</details>

<!-- ============ 中規模タスク（100-500行）============ -->
<details>
<summary>中規模実装フェーズ</summary>

### Phase 1: 設計（1-2時間）
- [ ] インターフェース設計
- [ ] データ構造定義
- [ ] エラー型定義

### Phase 2: 実装（4-8時間）
- [ ] コア機能実装
- [ ] ユニットテスト作成
- [ ] 統合テスト作成

### Phase 3: 品質チェック（1時間）
```bash
# 基本チェック
cargo test --all
cargo clippy -- -D warnings
cargo fmt --check

# 重複チェック
similarity-rs --threshold 0.80 --skip-test src/
# 閾値超えの重複があれば rust-refactor.md 適用
```

### Phase 4: 最適化（必要に応じて）
- [ ] ベンチマーク実施
- [ ] ボトルネック特定
- [ ] SIMD/並列化検討

</details>

<!-- ============ 大規模タスク（500行以上）============ -->
<details>
<summary>大規模実装フェーズ</summary>

### Phase 1: 設計フェーズ（1日）
- [ ] アーキテクチャ設計
- [ ] モジュール分割設計
- [ ] インターフェース定義
- [ ] エラーハンドリング設計

### Phase 2: 段階的実装（3-5日）

#### マイルストーン1: コア機能
- [ ] 基本データ構造
- [ ] コアアルゴリズム
- [ ] 単体テスト
- [ ] **中間品質チェック**
  ```bash
  cargo test
  cargo clippy
  similarity-rs --threshold 0.80 src/
  ```

#### マイルストーン2: 拡張機能
- [ ] 追加機能実装
- [ ] PyO3バインディング
- [ ] 統合テスト
- [ ] **similarity-rs実行**

#### マイルストーン3: 最適化
- [ ] SIMD実装（必要な場合）
- [ ] 並列化（Rayon）
- [ ] ベンチマーク

### Phase 3: 統合テスト（1日）
- [ ] 全機能の統合テスト
- [ ] パフォーマンステスト
- [ ] メモリリークチェック

### Phase 4: リファクタリングフェーズ（必須: 1日）
- [ ] **rust-refactor.md 完全適用**
- [ ] similarity-rs で最終確認
- [ ] コード整理と最適化
- [ ] ドキュメント完成

</details>

## 技術要件

### 必須要件
- [ ] エラー率 < `src/constants.rs::EPSILON`（実務精度）（数値計算の場合）
- [ ] メモリ安全性（Rust保証）
- [ ] スレッド安全性（Send + Sync）

### パフォーマンス目標
- [ ] 単一計算: < [X] ns
- [ ] バッチ処理: < [Y] ms（データサイズ記載）
- [ ] メモリ使用量: 入力データの[Z]倍以内

### PyO3連携（該当する場合）
- [ ] ゼロコピー実装
- [ ] GIL解放での並列処理
- [ ] 適切なエラー変換

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 例: SIMD可搬性 | 中 | 動的ディスパッチ実装 |
| 例: 数値精度劣化 | 高 | ゴールデンマスターテスト |

## チェックリスト

### 実装前
- [ ] 既存コードの確認（`similarity-rs`で類似実装チェック）
- [ ] 依存関係の確認
- [ ] 設計レビュー（大規模の場合）

### 実装中
- [ ] 定期的なテスト実行
- [ ] コミット前の`cargo fmt`
- [ ] 段階的な動作確認

### 実装後
- [ ] 全品質ゲート通過
- [ ] ベンチマーク結果記録
- [ ] ドキュメント更新
- [ ] 計画のarchive移動

## 成果物

- [ ] 実装コード（src/以下）
- [ ] テストコード（tests/以下）
- [ ] ベンチマーク（benches/以下）
- [ ] ドキュメント（rustdoc）
- [ ] PyO3バインディング（該当する場合）

## 備考

[追加の注意事項、参考資料、関連issue等を記載]