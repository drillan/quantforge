# Black76モデル（商品オプション）実装計画

**ステータス**: ACTIVE  
**作成日**: 2025-08-26  
**最終更新**: 2025-08-26  
**優先度**: HIGH  
**依存関係**: 2025-08-26-multi-model-architecture.md（フェーズ1完了）

## 概要

Black76モデルは、先物やフォワード契約のオプション価格を計算するためのモデルです。主に商品（コモディティ）、金利、エネルギー市場で使用されます。

## 背景

### モデルの特徴
- **用途**: 商品先物、金利先物、エネルギーデリバティブ
- **特徴**: スポット価格の代わりにフォワード価格を使用
- **利点**: 保管コストや便益利回りを暗黙的に含む

### 数学的基礎

```
d1 = (ln(F/K) + σ²/2 * T) / (σ * √T)
d2 = d1 - σ * √T

Call = exp(-r*T) * (F * N(d1) - K * N(d2))
Put = exp(-r*T) * (K * N(-d2) - F * N(-d1))
```

ここで、F = フォワード価格

## 実装計画

### タスク1: モジュール構造の作成
- [ ] `src/models/black76/mod.rs` - モジュール定義
- [ ] `src/models/black76/pricing.rs` - 価格計算ロジック
- [ ] `src/models/black76/greeks.rs` - グリークス計算
- [ ] `src/models/black76/implied_volatility.rs` - IV計算

### タスク2: パラメータ構造体の定義
```rust
pub struct Black76Params {
    pub f: f64,      // フォワード価格（スポット価格の代わり）
    pub k: f64,      // 権利行使価格
    pub t: f64,      // 満期までの時間
    pub r: f64,      // リスクフリーレート（割引用）
    pub sigma: f64,  // ボラティリティ
}
```

### タスク3: 価格計算の実装
- [ ] フォワード価格ベースのコール計算
- [ ] フォワード価格ベースのプット計算
- [ ] 割引係数の事前計算最適化
- [ ] バッチ処理対応（SIMD最適化）

### タスク4: グリークス計算の実装
Black76固有のグリークス：
- [ ] Delta: フォワード価格に対する感応度
- [ ] Gamma: フォワード価格ベース
- [ ] Theta: 時間価値減衰
- [ ] Vega: ボラティリティ感応度
- [ ] Rho: 割引率に対する感応度

### タスク5: 商品市場特有の拡張
- [ ] 複数満期のストリップ価格計算
- [ ] カレンダースプレッド対応
- [ ] アジア型オプションへの拡張準備

### タスク6: Python APIの実装
```python
# python/quantforge/models/black76.py
def call_price(f, k, t, r, sigma):
    """商品先物のコールオプション価格"""
    
def put_price(f, k, t, r, sigma):
    """商品先物のプットオプション価格"""
    
def greeks(f, k, t, r, sigma, is_call=True):
    """商品先物のグリークス"""
    
def from_spot_to_forward(s, r, q, t):
    """スポット価格からフォワード価格への変換"""
```

### タスク7: テストの実装
- [ ] 単体テスト（価格計算の精度検証）
- [ ] Put-Callパリティのテスト
- [ ] 境界値テスト（T→0、F→0、F→∞）
- [ ] Black-Scholesとの一貫性テスト
- [ ] パフォーマンステスト

### タスク8: ドキュメント作成
- [ ] `docs/models/black76.md` - モデル説明
- [ ] `docs/api/python/black76.md` - API文書
- [ ] 商品市場での使用例
- [ ] フォワード価格の計算方法

## 技術的詳細

### フォワード価格の扱い
```rust
// フォワード価格は直接入力として受け取る
// スポット価格からの変換はユーザー側で行う
// F = S * exp((r - q) * T)  // 参考式
```

### Black-Scholesとの関係
- Black76は`S = F * exp(-r*T)`と置換したBlack-Scholes
- 数値計算の効率化（exp関数の削減）

### 最適化の考慮点
- 割引係数`exp(-r*T)`の事前計算
- d1, d2の計算最適化
- SIMD対応バッチ処理

## 検証基準

### 精度要件
- 価格精度: 相対誤差 < 1e-6
- グリークス精度: 相対誤差 < 1e-5
- Put-Callパリティ: 誤差 < 1e-10

### パフォーマンス要件
- 単一計算: < 12ns
- バッチ処理（100万件）: < 25ms

### 市場慣行との整合性
- 商品市場の標準的な価格表記
- 先物満期日の扱い
- 営業日カレンダー対応（将来）

## リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| フォワード価格の誤解釈 | HIGH | 明確なドキュメント、変換関数の提供 |
| 金利期間構造の簡略化 | MEDIUM | 単一金利から開始、段階的拡張 |
| 商品固有の慣行 | LOW | 市場別の拡張ポイント準備 |

## 商品市場での応用例

### エネルギー市場
```python
# 原油先物オプション
oil_forward = 75.0  # WTI先物価格
strike = 80.0
time = 0.25  # 3ヶ月
rate = 0.05
vol = 0.30

call_price = black76.call_price(oil_forward, strike, time, rate, vol)
```

### 農産物市場
```python
# コーン先物オプション
corn_forward = 650.0  # cents/bushel
strike = 700.0
# ...
```

## 参考資料

- Black, F. (1976). "The pricing of commodity contracts"
- Davis Edwards "Energy Trading and Investing"
- draft/GBS_2025.py - Black76実装の参照

## 成功基準

1. **正確性**: 市場標準ツールとの誤差 < 1e-6
2. **性能**: Black-Scholesと同等の実行速度
3. **テスト**: カバレッジ90%以上
4. **ドキュメント**: 商品市場での使用例を含む
5. **拡張性**: 他の商品オプションモデルへの拡張準備

## 次のステップ

1. モジュール構造の作成
2. 基本的な価格計算の実装
3. グリークス計算の追加
4. 商品市場固有の拡張

## 将来の拡張計画

- Asian76モデル（アジアンオプション）
- スプレッドオプション対応
- 季節性の考慮
- ストレージコストの明示的モデリング

## 更新履歴

- 2025-08-26: 初版作成（2025-08-26-multi-model-architecture.mdから分離）